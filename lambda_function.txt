import boto3
import json

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('todos')

def get_next_id():
    response = table.scan()
    items = response.get('Items', [])
    
    if not items:
        return 1 

    max_id = max(int(item['id']) for item in items) 
    return max_id + 1

def lambda_handler(event, context):
    http_method = event["httpMethod"]
    path = event.get('path', '')
    
    headers = {
        "Access-Control-Allow-Origin": "*",  
        "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE",  
        "Access-Control-Allow-Headers": "Content-Type"  
    }

    # create new item (Create)
    if http_method == "POST" and path == '/items':
        item_id = get_next_id()
        data = json.loads(event['body']) 
        data['id'] = str(item_id)
        table.put_item(Item=data)

        response = {
           "statusCode": 200,
           "body": json.dumps({"message": "Item added or posted"}),
           "headers": headers  
        }
        return response

    # update item by id (Update)
    elif http_method == "PUT" and path.startswith('/items/'):
        item_id = path.split('/')[-1]
        data = json.loads(event['body']) 
        data['id'] = str(item_id)
        table.put_item(Item=data)

        response = {
           "statusCode": 200,
           "body": json.dumps({"message": "Item updated or posted"}),
           "headers": headers 
        }
        return response
        
    # fetch all items (Read)
    elif http_method == "GET" and path == '/items':
        count = table.scan()
        items = count.get('Items', [])
        response = {
            "statusCode": 200,
            "body": json.dumps(items),
            "headers": headers  
        }
        return response

    # delete all items (Delete)
    elif http_method == "DELETE" and path == '/items':
        count = table.scan()
        items = count.get('Items', [])
        for item in items:
            table.delete_item(Key={'id': item['id']})
        response = {
           "statusCode": 200,
           "body": json.dumps({"message": "All items deleted"}),
           "headers": headers  
        }
        return response
    
    # delete item by id (Delete by id)
    elif http_method == "DELETE" and path.startswith('/items/'):
        item_id = path.split('/')[-1]
        table.delete_item(Key={'id': item_id})
        response = {
           "statusCode": 200,
           "body": json.dumps({"message": "Item deleted"}),
           "headers": headers  
        }
        return response
